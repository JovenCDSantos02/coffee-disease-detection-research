<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recorded Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="{{ url_for('serve_static', path='manifest.json') }}">
</head>
<body>
    <h1>Recorded Results</h1>

    <label for="month-year">Select Month and Year:</label>
    <select id="month-year" onchange="updateGraph()">
        <!-- Populate options dynamically -->
    </select>

    <label for="affiliation">Select Affiliation:</label>
    <select id="affiliation" onchange="updateGraph()">
        <option value="City A">City A</option>
        <option value="City B">City B</option>
        <option value="City C">City C</option>
    </select>

    <canvas id="resultsChart"></canvas>

    <script>
        let allRecords = [];
        const chart = createChart();

        // Function to initialize Chart.js
        function createChart() {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Leaf Scale', 'Mealy Bug', 'Twig Borer', 'Anthracnose', 'Brown Eye', 'Leaf Rust'],
                    datasets: [{
                        label: 'Tally of Results',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Fetch data from Flask and initialize dropdowns and chart
        async function fetchRecords() {
            const response = await fetch('/get-records');
            allRecords = await response.json();
            populateMonthYearDropdown();
            updateGraph(); // Initial graph update
        }

        // Populate the month-year dropdown based on available records
        function populateMonthYearDropdown() {
            const monthYearSelect = document.getElementById('month-year');
            const uniqueMonthYears = [...new Set(allRecords.map(record => {
                const [year, month] = record.date.split('-').slice(0, 2);
                return `${getMonthName(month)} ${year}`;
            }))];

            uniqueMonthYears.forEach(monthYear => {
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = monthYear;
                monthYearSelect.appendChild(option);
            });

            // Set current month-year as default
            const currentMonthYear = getCurrentMonthYear();
            monthYearSelect.value = currentMonthYear;
        }

        // Get current month and year in "Month Year" format
        function getCurrentMonthYear() {
            const now = new Date();
            const month = now.getMonth() + 1; // JavaScript months are 0-indexed
            const year = now.getFullYear();
            return `${getMonthName(month.toString().padStart(2, '0'))} ${year}`;
        }

        // Helper to convert numeric month to string (e.g., "09" -> "September")
        function getMonthName(month) {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];
            return monthNames[parseInt(month) - 1];
        }

        // Filter records and update the graph
        function updateGraph() {
            const selectedMonthYear = document.getElementById("month-year").value;
            const selectedAffiliation = document.getElementById("affiliation").value;

            // Convert selectedMonthYear to "YYYY-MM"
            const [monthName, year] = selectedMonthYear.split(" ");
            const month = ("0" + (new Date(monthName + " 1, 2000").getMonth() + 1)).slice(-2);
            const filterDate = `${year}-${month}`;

            // Filter the records based on selected month-year and affiliation
            const filteredRecords = allRecords.filter(record => {
                return record.date.startsWith(filterDate) && record.affiliation === selectedAffiliation;
            });

            // Tally the results
            const resultsTally = {
                "Leaf Scale": 0,
                "Mealy Bug": 0,
                "Twig Borer": 0,
                "Anthracnose": 0,
                "Brown Eye": 0,
                "Leaf Rust": 0
            };

            filteredRecords.forEach(record => {
                resultsTally[record.results] = (resultsTally[record.results] || 0) + 1;
            });

            // Update the chart with new data
            chart.data.datasets[0].data = Object.values(resultsTally);
            chart.update();
        }

        // Fetch records on page load
        window.onload = fetchRecords;
    </script>
    <div class="download-circle" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #4CAF50; display: flex; align-items: center; justify-content: center; cursor: pointer;">
        <img src="{{ url_for('serve_static', path='assets/images/download-icon.png') }}" alt="Download" style="width: 30px; height: 30px;" onclick="downloadApp()">
    </div>
<script src="{{ url_for('serve_static', path='assets/js/app.js') }}"></script>
</body>
</html>
